#!/usr/bin/env bash
#author      :Tomas Skalicky <skalicky.tomas@gmail.com>
#===============================================================================

#-------------------------------------------------------------------------------

update_eclipse_ini() {
    #~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~
    local -r filepath=${1:?}
    #~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~
    local -r prefixes_of_lines_to_remove=(
        -Dosgi.requiredJavaVersion=
        -Xms
        -Xmx
        -Xss
        -XX:MaxMetaspaceSize=
        -Duser.name=
        -Duser.email=
    )
    remove_lines_with_prefixes_from_file "$filepath" "${prefixes_of_lines_to_remove[@]}"
    #~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~
    local block_contents
    set +e
    read -r -d '' block_contents <<- EOF
	-Dosgi.requiredJavaVersion=1.8
	-Xms512m
	-Xmx4096m
	# -Xss determines the size of stack
	-Xss16m
	-XX:MaxMetaspaceSize=512m
	-Duser.name=${user_full_name:?}
	-Duser.email=${user_email:?}
	EOF
    set -e
    local -r begin_comment='# <BEGIN> Custom configuration - generated by eclipse role'
    local -r end_comment='# <END> Custom configuration - generated by eclipse role'
    set_or_replace_block_contents_in_file \
                                          "$filepath" \
                                          "$block_contents" \
                                          "$begin_comment" \
                                          "$end_comment"
    #~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~
}

#-------------------------------------------------------------------------------

install_eclipse() {
    #~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~
    local -A eclipse
    # shellcheck disable=SC2154
    eclipse[major_version]=oxygen
    # shellcheck disable=SC2154
    eclipse[minor_version]=R
    # shellcheck disable=SC2154
    eclipse[product]=eclipse-jee-${eclipse[major_version]}-${eclipse[minor_version]}
    # shellcheck disable=SC2154
    eclipse[installer_filename]=eclipse-jee-${eclipse[major_version]}-${eclipse[minor_version]}-linux-gtk-x86_64.tar.gz
    # shellcheck disable=SC2154
    eclipse[installer_filepath]=$user_downloads/${eclipse[installer_filename]}
    # shellcheck disable=SC2154
    eclipse[unpacked_path]=$user_downloads/eclipse
    # shellcheck disable=SC2154
    eclipse[root]=${additional_software_root:?}/eclipse
    # shellcheck disable=SC2154
    eclipse[installation_path]=${eclipse[root]}/${eclipse[product]}
    # shellcheck disable=SC2154
    eclipse[link_name]=/usr/bin/eclipse
    # shellcheck disable=SC2154
    eclipse[link_target]=${eclipse[installation_path]}/eclipse
    # shellcheck disable=SC2154
    eclipse[link_exists]=false
    # shellcheck disable=SC2154
    eclipse[link_up_to_date]=false
    #~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~
    if [[ -L ${eclipse[link_name]} ]]; then
        eclipse[link_exists]=true
        local -r current_link_target=$(realpath ${eclipse[link_name]})
        if [[ $current_link_target = "${eclipse[link_target]}" ]]; then
            print_info "The link target $current_link_target is the correct" \
                       "one, hence Eclipse is very likely up to date."
            eclipse[link_up_to_date]=true
        else
            print_info "Removes the Eclipse link since the current link" \
                       "target $current_link_target is obsolete. The new one" \
                       "is ${eclipse[link_target]}."
            eclipse[link_up_to_date]=false
        fi
    fi
    #~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~
    if ! ${eclipse[link_up_to_date]}; then
        if [[ ! -d ${eclipse[root]} ]]; then
            mkdir --verbose --parents "${eclipse[root]}"
        fi
        if [[ ! -f ${eclipse[installer_filepath]} ]]; then
            # Do not change r=1 to mirror_id=FOO. The download via wget would
            # not work.
            wget \
                 --output-document="${eclipse[installer_filepath]}" \
                 "https://www.eclipse.org/downloads/download.php?file=/technology/epp/downloads/release/${eclipse[major_version]}/${eclipse[minor_version]}/${eclipse[installer_filename]}&r=1"
        fi
        #~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~
        tar --gzip --extract --file "${eclipse[installer_filepath]}" --directory "$user_downloads"
        rm --force --recursive "${eclipse[installation_path]}"
        mv --verbose "${eclipse[unpacked_path]}" "${eclipse[installation_path]}"
        # If the installation needs to be restarted, keeping the install till
        # the end and removing there can save us repeatition of downloading.
        rm --force --recursive "${eclipse[installer_filepath]}"
    fi
    #~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~
    local -r filepath=${eclipse[installation_path]}/eclipse.ini
    update_eclipse_ini "$filepath"
    #~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~
    if ! ${eclipse[link_up_to_date]}; then
        if ${eclipse[link_exists]}; then
            unlink "${eclipse[link_name]}"
        fi
        ln --verbose --symbolic "${eclipse[link_target]}" "${eclipse[link_name]}"
    fi
    #~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~
}

#-------------------------------------------------------------------------------

main() {
    install_eclipse
}

#-------------------------------------------------------------------------------

main

